{% extends "layout.html" %}
{% block title %}Code Sandbox{% endblock %}
{% block header %}Code Sandbox{% endblock %}

{% block content %}
<div class="bg-gray-900 border border-slate-700 rounded-lg shadow-lg p-4 md:p-6 text-white h-full flex flex-col min-h-[85vh]">
    <h2 class="text-2xl font-bold text-white mb-4">Python Simulator</h2>
    <p class="text-slate-400 mb-6 text-sm md:text-base">
        Write your Python code below and click "Run" to see the output. Press Ctrl+Space for autocomplete.
    </p>

    <div class="flex-grow grid grid-cols-1 md:grid-cols-2 gap-6">
        <!-- Code editor -->
        <div class="flex flex-col h-80 md:h-full">
            <label for="python-editor" class="text-sm font-semibold mb-2 text-slate-300">Editor</label>
            <div class="flex-grow h-full">
                <textarea id="python-editor"></textarea>
            </div>
        </div>

        <!-- Output panel -->
        <div class="flex flex-col h-80 md:h-full">
            <label for="output" class="text-sm font-semibold mb-2 text-slate-300">Console</label>
            <div id="output" class="w-full h-full p-4 rounded-lg bg-black text-green-300 font-mono overflow-auto">
                <!-- Execution results will show here -->
            </div>
        </div>
    </div>

    <div class="mt-4 flex justify-between">
        <button id="clear-btn" class="bg-red-600 hover:bg-red-700 text-white font-semibold py-2 px-4 rounded-lg shadow">
            Clear Console
        </button>
        <button id="run-btn" class="bg-green-600 hover:bg-green-700 text-white font-semibold py-2 px-4 rounded-lg shadow">
            Run
        </button>
    </div>
</div>

<!-- Brython -->
<script type="text/javascript" src="https://cdn.jsdelivr.net/npm/brython@3.11.0/brython.min.js"></script>
<script type="text/javascript" src="https://cdn.jsdelivr.net/npm/brython@3.11.0/brython_stdlib.js"></script>

<!-- CodeMirror -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.10/codemirror.min.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.10/theme/dracula.min.css">
<!-- Addon for autocomplete -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.10/addon/hint/show-hint.min.css">

<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.10/codemirror.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.10/mode/python/python.min.js"></script>
<!-- Addon scripts for autocomplete -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.10/addon/hint/show-hint.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.10/addon/hint/python-hint.js"></script>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        brython();

        // Initialize CodeMirror editor with autocomplete
        window.editor = CodeMirror.fromTextArea(document.getElementById("python-editor"), {
            mode: "python",
            theme: "dracula",
            lineNumbers: true,
            indentUnit: 4,
            smartIndent: true,
            matchBrackets: true,
            autofocus: true,
            extraKeys: {"Ctrl-Space": "autocomplete"} // Enable autocomplete on Ctrl+Space
        });
        // Set CodeMirror to fill its container
        editor.setSize("100%", "100%");
    });

    // Append text to output panel
    function writeToOutput(message, isError = false) {
        const outputDiv = document.getElementById("output");
        const line = document.createElement("div");
        line.textContent = message;
        line.className = isError ? "text-red-400" : "";
        outputDiv.appendChild(line);

        // Auto-scroll to bottom
        outputDiv.scrollTop = outputDiv.scrollHeight;
    }

    // Run button logic
    document.getElementById("run-btn").addEventListener("click", () => {
        let code = editor.getValue();
        const outputDiv = document.getElementById("output");

        // Clear old output before running
        outputDiv.innerHTML = "";

        try {
            // Redirect Brython stdout/stderr
            window.__BRYTHON__.stdout.write = function(data) {
                writeToOutput(data);
            };
            window.__BRYTHON__.stderr.write = function(data) {
                writeToOutput("❌ " + data, true);
            };

            let jsCode = __BRYTHON__.python_to_js(code);
            eval(jsCode);

        } catch (err) {
            writeToOutput("❌ Error: " + err.message, true);
        }
    });

    // Clear button logic
    document.getElementById("clear-btn").addEventListener("click", () => {
        document.getElementById("output").innerHTML = "";
    });
</script>
{% endblock %}
