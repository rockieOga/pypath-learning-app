{% extends "layout.html" %}
{% block title %}{{ set_info.title }}{% endblock %}
{% block header %}{{ set_info.title }}{% endblock %}

{% block content %}
<!-- Timer Display -->
<div class="fixed top-20 right-6 bg-white p-3 rounded-lg shadow-lg border text-center z-10 w-36">
    <p class="text-xs font-semibold text-gray-500 uppercase tracking-wider">Time Elapsed</p>
    <div id="timer" class="text-2xl font-bold text-sky-700 font-mono">00:00</div>
</div>

<div class="max-w-4xl mx-auto">
    <div class="bg-white p-8 rounded-xl shadow-lg">
        <p class="text-center text-gray-600 mb-8">{{ set_info.description }}</p>
        
        <form id="quizForm" action="{{ url_for('submit_quiz', set_id=set_info.id) }}" method="POST" class="space-y-8">
            {% for question in questions %}
            <div class="border-t pt-6 question-block" data-question-id="{{ question.id }}">
                <p class="text-lg font-semibold text-gray-800 mb-4">{{ loop.index }}. {{ question.question_text }}</p>
                
                {% if question.question_type == 'multiple_choice' %}
                <div class="space-y-2">
                    <label class="flex items-center p-3 rounded-lg border border-gray-200 hover:bg-gray-50 cursor-pointer">
                        <input type="radio" name="question_{{ question.id }}" value="A" class="h-4 w-4 text-sky-600 border-gray-300 focus:ring-sky-500">
                        <span class="ml-3 text-gray-700">{{ question.option_a }}</span>
                    </label>
                    <label class="flex items-center p-3 rounded-lg border border-gray-200 hover:bg-gray-50 cursor-pointer">
                        <input type="radio" name="question_{{ question.id }}" value="B" class="h-4 w-4 text-sky-600 border-gray-300 focus:ring-sky-500">
                        <span class="ml-3 text-gray-700">{{ question.option_b }}</span>
                    </label>
                    <label class="flex items-center p-3 rounded-lg border border-gray-200 hover:bg-gray-50 cursor-pointer">
                        <input type="radio" name="question_{{ question.id }}" value="C" class="h-4 w-4 text-sky-600 border-gray-300 focus:ring-sky-500">
                        <span class="ml-3 text-gray-700">{{ question.option_c }}</span>
                    </label>
                    <label class="flex items-center p-3 rounded-lg border border-gray-200 hover:bg-gray-50 cursor-pointer">
                        <input type="radio" name="question_{{ question.id }}" value="D" class="h-4 w-4 text-sky-600 border-gray-300 focus:ring-sky-500">
                        <span class="ml-3 text-gray-700">{{ question.option_d }}</span>
                    </label>
                </div>
                {% elif question.question_type == 'coding' %}
                <div class="coding-question-container" data-question-id="{{ question.id }}">
                    <div class="h-64 mb-4 border rounded-md overflow-hidden">
                        <textarea id="editor-{{ question.id }}"></textarea>
                    </div>
                    <div class="flex justify-between items-start gap-4">
                        <button type="button" class="run-code-btn bg-emerald-500 text-white font-semibold py-2 px-4 rounded-lg hover:bg-emerald-600">Run Code</button>
                        <pre class="output-console bg-slate-900 text-white text-sm p-2 rounded-md w-2/3 h-24 overflow-y-auto whitespace-pre-wrap"></pre>
                    </div>
                    <textarea name="question_{{ question.id }}" class="hidden-code-input hidden"></textarea>
                </div>
                {% endif %}
            </div>
            {% endfor %}
            
            <div class="text-center pt-6">
                <button type="submit" class="bg-sky-600 text-white font-bold py-3 px-8 rounded-lg shadow-lg hover:bg-sky-700">
                    Submit Quiz
                </button>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block scripts %}
<!-- Brython & CodeMirror -->
<script type="text/javascript" src="https://cdn.jsdelivr.net/npm/brython@3.11.0/brython.min.js"></script>
<script type="text/javascript" src="https://cdn.jsdelivr.net/npm/brython@3.11.0/brython_stdlib.js"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.10/codemirror.min.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.10/theme/dracula.min.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.10/codemirror.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.10/mode/python/python.min.js"></script>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        brython();

        document.querySelectorAll('.coding-question-container').forEach(container => {
            const questionId = container.dataset.questionId;
            const editorTextarea = container.querySelector(`#editor-${questionId}`);
            const hiddenInput = container.querySelector('.hidden-code-input');
            const runBtn = container.querySelector('.run-code-btn');
            const outputConsole = container.querySelector('.output-console');

            const editor = CodeMirror.fromTextArea(editorTextarea, {
                mode: "python",
                theme: "dracula",
                lineNumbers: true,
                indentUnit: 4
            });
            editor.setSize("100%", "100%");

            editor.on('change', () => {
                hiddenInput.value = editor.getValue();
            });

            runBtn.addEventListener('click', () => {
                const code = editor.getValue();
                outputConsole.textContent = "";

                window.__BRYTHON__.stdout.write = (data) => { outputConsole.textContent += data; };
                window.__BRYTHON__.stderr.write = (data) => { outputConsole.textContent += "Error: " + data; };

                try {
                    const jsCode = __BRYTHON__.python_to_js(code);
                    eval(jsCode);
                } catch (err) {
                    outputConsole.textContent = "Error: " + err.message;
                }
            });
        });

        // --- Form Submission Validation ---
        const quizForm = document.getElementById('quizForm');
        quizForm.addEventListener('submit', function(event) {
            let allAnswered = true;
            const questions = document.querySelectorAll('.question-block');

            questions.forEach(questionDiv => {
                const questionId = questionDiv.dataset.questionId;
                let answered = false;

                // Check multiple choice questions
                const radioButtons = questionDiv.querySelectorAll(`input[name="question_${questionId}"]`);
                if (radioButtons.length > 0) {
                    for (const radio of radioButtons) {
                        if (radio.checked) {
                            answered = true;
                            break;
                        }
                    }
                }

                // Check coding questions
                const codingInput = questionDiv.querySelector(`.hidden-code-input`);
                if (codingInput && codingInput.value.trim() !== '') {
                    answered = true;
                }
                
                // If a question is unanswered, highlight it
                if (!answered) {
                    allAnswered = false;
                    questionDiv.style.border = '2px solid #ef4444'; // Red border
                    questionDiv.style.padding = '1.5rem';
                    questionDiv.style.borderRadius = '0.5rem';
                } else {
                    questionDiv.style.border = ''; // Remove highlight if answered
                    questionDiv.style.padding = '1.5rem 0 0 0';
                }
            });

            if (!allAnswered) {
                event.preventDefault(); // Stop the form from submitting
                alert('Please answer all questions before submitting.');
            }
        });
    });

    // Timer script
    const timerElement = document.getElementById('timer');
    let seconds = 0;
    function formatTime(sec) {
        const minutes = Math.floor(sec / 60);
        const remainingSeconds = sec % 60;
        return `${String(minutes).padStart(2, '0')}:${String(remainingSeconds).padStart(2, '0')}`;
    }
    setInterval(() => {
        seconds++;
        timerElement.textContent = formatTime(seconds);
    }, 1000);
</script>
{% endblock %}
